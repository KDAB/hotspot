name: compile and test

on:
  push:
    branches: "**"

jobs:
  ubuntu-2004:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: compile
      run: docker build -t hotspot-build-ubuntu20.04 -f scripts/compile-test/Ubuntu20.04 .
    - name: run unit tests
      run: docker run hotspot-build-ubuntu20.04 bash -c "cd hotspot/build/ && ctest --output-on-failure -j \$(nproc) -E tst_perfdata"

  ubuntu-2204:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: compile
      run: docker build -t hotspot-build-ubuntu22.04 -f scripts/compile-test/Ubuntu22.04 .
    - name: run unit tests
      run: docker run hotspot-build-ubuntu22.04 bash -c "cd hotspot && ctest --preset dev-asan -j \$(nproc)"

  archlinux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: compile
      run: docker build -t hotspot-build-archlinux -f scripts/compile-test/Archlinux .
    - name: run unit tests
      run: docker run hotspot-build-archlinux bash -c "cd hotspot && ctest --preset dev-asan -j \$(nproc)"

  fedora34:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: compile
      run: docker build -t hotspot-build-fedora34 -f scripts/compile-test/Fedora34 .
    - name: run unit tests
      run: docker run hotspot-build-fedora34 bash -c "cd hotspot/build/ && ctest --output-on-failure -j \$(nproc)"

  opensuse-tumbleweed:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: compile
      run: docker build -t hotspot-build-opensuse-tumbleweed -f scripts/compile-test/OpenSuseTumbleweed .
    - name: run unit tests
      run: docker run hotspot-build-opensuse-tumbleweed bash -c "cd hotspot/build/ && ctest --output-on-failure -j \$(nproc)"
